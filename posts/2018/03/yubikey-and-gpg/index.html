<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>YubiKey and GPG - Daniel's blog</title><meta name=Description content="This is my cool site"><meta property="og:url" content="https://blog.spatof.org/posts/2018/03/yubikey-and-gpg/">
<meta property="og:site_name" content="Daniel's blog"><meta property="og:title" content="YubiKey and GPG"><meta property="og:description" content="How to configure a YubiKey to be used as a GnuPG smart-card device."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-03-26T00:00:00+00:00"><meta property="article:modified_time" content="2018-03-26T00:00:00+00:00"><meta property="article:tag" content="Yubikey"><meta property="article:tag" content="Gpg"><meta property="article:tag" content="Gpg2"><meta property="article:tag" content="Ssh"><meta property="article:tag" content="Gpg-Agent"><meta name=twitter:card content="summary"><meta name=twitter:title content="YubiKey and GPG"><meta name=twitter:description content="How to configure a YubiKey to be used as a GnuPG smart-card device."><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.spatof.org/posts/2018/03/yubikey-and-gpg/><link rel=prev href=https://blog.spatof.org/posts/2018/02/into-the-breach-on-os-x-with-wine/><link rel=next href=https://blog.spatof.org/posts/2018/12/ferm-and-docker-playing-together/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"YubiKey and GPG","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.spatof.org\/posts\/2018\/03\/yubikey-and-gpg\/"},"genre":"posts","keywords":"yubikey, gpg, gpg2, ssh, gpg-agent","wordcount":3019,"url":"https:\/\/blog.spatof.org\/posts\/2018\/03\/yubikey-and-gpg\/","datePublished":"2018-03-26T00:00:00+00:00","dateModified":"2018-03-26T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Daniel Kertesz"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Daniel's blog">blog.spatof.org</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/ title=About>About </a><a class=menu-item href=/youtube-links/ title="Youtube Links">Youtube Links </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Daniel's blog">blog.spatof.org</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title=About>About</a><a class=menu-item href=/youtube-links/ title="Youtube Links">Youtube Links</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">YubiKey and GPG</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Daniel Kertesz</a></span>&nbsp;<span class=post-category>included in <a href=/categories/tutorial/><i class="far fa-folder fa-fw" aria-hidden=true></i>Tutorial</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2018-03-26>2018-03-26</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;3019 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;15 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#requirements>Requirements</a></li><li><a href=#references>References</a></li><li><a href=#configuring-the-yubikey>Configuring the Yubikey</a><ul><li><a href=#creating-the-gnupg-keys>Creating the GnuPG keys</a></li><li><a href=#create-the-first-secret-key>Create the first secret key</a></li><li><a href=#create-the-3-secret-keys>Create the 3 secret keys</a></li><li><a href=#configure-the-pin-on-the-yubikey>Configure the PIN on the YubiKey</a></li><li><a href=#upload-the-secret-keys-to-the-yubikey>Upload the secret keys to the YubiKey</a></li><li><a href=#final-check-and->Final check and ðŸ˜Œ</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>This guide explains how to store a GnuPG key into a YubiKey; specifically it will explain how to:</p><ul><li>create a &ldquo;master secret key&rdquo;</li><li>create 3 subkeys: 1 used to sign, 1 used to encrypt and 1 used to authenticate (e.g. OpenSSH)</li><li>store the subkeys on a YubiKey</li><li>have the YubiKey act as a U2F device, a Smart Card device for GnuPG and an OTP device</li></ul><p><strong>NOTE</strong>: the secret keys stored on the YubiKey will be protected by a numeric PIN.</p><h2 id=requirements>Requirements</h2><ul><li>YubiKey 3.0 or above</li><li>gpg1 / gpg2</li></ul><p>On OS X:</p><pre><code>brew install gpg pinentry-mac ykpers
</code></pre><p>Somehow <code>pinentry</code> does not work for me and I have to use <code>pinentry-mac</code>.</p><h2 id=references>References</h2><ul><li><a href=https://www.jfry.me/articles/2015/gpg-smartcard/ target=_blank rel="noopener noreffer">https://www.jfry.me/articles/2015/gpg-smartcard/</a></li></ul><h2 id=configuring-the-yubikey>Configuring the Yubikey</h2><p>Configure <code>OTP/U2F/CCID</code> mode:</p><pre><code>$ ykpersonalize -m86
Firmware version 3.4.3 Touch level 1541 Program sequence 1

The USB mode will be set to: 0x86

Commit? (y/n) [n]: y
</code></pre><p>Restart the YubiKey (unplug, insert back).</p><h3 id=creating-the-gnupg-keys>Creating the GnuPG keys</h3><h4 id=configure-gnupg>Configure GnuPG</h4><p>Ensure that you have a sane configuration for gpg (<code>~/.gnupg/gpg.conf</code>):</p><pre><code>no-emit-version
no-comments
keyid-format 0xlong
with-fingerprint
use-agent
personal-cipher-preferences AES256 AES192 AES CAST5
personal-digest-preferences SHA512 SHA384 SHA256 SHA224
cert-digest-algo SHA512
default-preference-list SHA512 SHA384 SHA256 SHA224 AES256 AES192 AES CAST5 ZLIB BZIP2 ZIP Uncompressed
</code></pre><p>And for <code>gpg-agent</code> (<code>~/.gnupg/gpg-agent.conf</code>):</p><pre><code>use-standard-socket
enable-ssh-support
pinentry-program /usr/local/bin/pinentry-mac
</code></pre><p><strong>NOTE</strong>: the path to <code>pinentry</code> could be different on your system.</p><h3 id=create-the-first-secret-key>Create the first secret key</h3><p>Create the master secret key:</p><pre><code>$ gpg --gen-key
gpg (GnuPG) 1.4.19; Copyright (C) 2015 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Please select what kind of key you want:
   (1) RSA and RSA (default)
   (2) DSA and Elgamal
   (3) DSA (sign only)
   (4) RSA (sign only)
Your selection? 4
RSA keys may be between 1024 and 4096 bits long.
What keysize do you want? (2048) 4096
Requested keysize is 4096 bits
Please specify how long the key should be valid.
         0 = key does not expire
      &lt;n&gt;  = key expires in n days
      &lt;n&gt;w = key expires in n weeks
      &lt;n&gt;m = key expires in n months
      &lt;n&gt;y = key expires in n years
Key is valid for? (0) 0
Key does not expire at all
Is this correct? (y/N) y

You need a user ID to identify your key; the software constructs the user ID
from the Real Name, Comment and Email Address in this form:
    &quot;Heinrich Heine (Der Dichter) &lt;heinrichh@duesseldorf.de&gt;&quot;

Real name: Pippo Goofy
Email address: pippo@example.com
Comment:
You selected this USER-ID:
    &quot;Pippo Goofy &lt;pippo@example.com&gt;&quot;

Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? o
You need a Passphrase to protect your secret key.

gpg: problem with the agent - disabling agent use
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
............+++++
........................+++++
gpg: key 0xAABBCCDDEEFFGGHH marked as ultimately trusted
public and secret key created and signed.

gpg: checking the trustdb
gpg: 3 marginal(s) needed, 1 complete(s) needed, PGP trust model
gpg: depth: 0  valid:   1  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 1u
pub   4096R/0xAABBCCDDEEFFGGHH 2015-10-27
      Key fingerprint = AAAA BBBB CCCC DDD EEEE  FFFF GGGG HHHH IIII LLLL
uid                 [ultimate] Pippo Goofy &lt;pippo@example.com&gt;

Note that this key cannot be used for encryption.  You may want to use
the command &quot;--edit-key&quot; to generate a subkey for this purpose.
</code></pre><p>Save your key in a variable:</p><pre><code>$ export KEY=0xAABBCCDDEEFFGGHH
</code></pre><h4 id=optional-create-a-keybase-identity>(Optional) Create a Keybase identity</h4><p>If you plan to use <a href=https://keybase.io target=_blank rel="noopener noreffer">Keybase</a>, add another <em>uid</em>:</p><pre><code>$ gpg --edit-key $KEY
gpg (GnuPG) 1.4.19; Copyright (C) 2015 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Secret key is available.

pub  4096R/0xAABBCCDDEEFFGGHH  created: 2015-10-27  expires: never       usage: SC
                               trust: ultimate      validity: ultimate
[ultimate] (1). Pippo Goofy &lt;pippo@example.com&gt;

gpg&gt; adduid
Real name: Pippo Goofy
Email address: pgoofy@keybase.io
Comment:
You selected this USER-ID:
    &quot;Pippo Goofy &lt;pgoofy@keybase.io&gt;&quot;

Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? o

You need a passphrase to unlock the secret key for
user: &quot;Pippo Goofy &lt;pippo@example.com&gt;&quot;
4096-bit RSA key, ID 0xAABBCCDDEEFFGGHH, created 2015-10-27

pub  4096R/0xAABBCCDDEEFFGGHH  created: 2015-10-27  expires: never       usage: SC
                               trust: ultimate      validity: ultimate
[ultimate] (1)  Pippo Goofy &lt;pippo@example.com&gt;
[ unknown] (2). Pippo Goofy &lt;pgoofy@keybase.io&gt;

gpg&gt; uid 1

pub  4096R/0xAABBCCDDEEFFGGHH  created: 2015-10-27  expires: never       usage: SC
                               trust: ultimate      validity: ultimate
[ultimate] (1)* Pippo Goofy &lt;pippo@example.com&gt;
[ unknown] (2). Pippo Goofy &lt;pgoofy@keybase.io&gt;

gpg&gt; primary

You need a passphrase to unlock the secret key for
user: &quot;Pippo Goofy &lt;pippo@example.com&gt;&quot;
4096-bit RSA key, ID 0xAABBCCDDEEFFGGHH, created 2015-10-27


pub  4096R/0xAABBCCDDEEFFGGHH  created: 2015-10-27  expires: never       usage: SC
                               trust: ultimate      validity: ultimate
[ultimate] (1)* Pippo Goofy &lt;pippo@example.com&gt;
[ unknown] (2)  Pippo Goofy &lt;pgoofy@keybase.io&gt;

gpg&gt; save
</code></pre><h3 id=create-the-3-secret-keys>Create the 3 secret keys</h3><p>Now generate 3 subkeys (1 to encrypt, 1 to sign, 1 for ssh):</p><pre><code>$ gpg --expert --edit-key $KEY
gpg (GnuPG) 1.4.19; Copyright (C) 2015 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Secret key is available.

pub  4096R/0xAABBCCDDEEFFGGHH  created: 2015-10-27  expires: never       usage: SC
                               trust: ultimate      validity: ultimate
[ultimate] (1). Pippo Goofy &lt;pippo@example.com&gt;
[ultimate] (2)  Pippo Goofy &lt;pgoofy@keybase.io&gt;

gpg&gt; addkey
Key is protected.

You need a passphrase to unlock the secret key for
user: &quot;Pippo Goofy &lt;pippo@example.com&gt;&quot;
4096-bit RSA key, ID 0xAABBCCDDEEFFGGHH, created 2015-10-27

gpg: problem with the agent - disabling agent use
Please select what kind of key you want:
   (3) DSA (sign only)
   (4) RSA (sign only)
   (5) Elgamal (encrypt only)
   (6) RSA (encrypt only)
   (7) DSA (set your own capabilities)
   (8) RSA (set your own capabilities)
Your selection? 4
RSA keys may be between 1024 and 4096 bits long.
What keysize do you want? (2048) 2048
Requested keysize is 2048 bits
Please specify how long the key should be valid.
         0 = key does not expire
      &lt;n&gt;  = key expires in n days
      &lt;n&gt;w = key expires in n weeks
      &lt;n&gt;m = key expires in n months
      &lt;n&gt;y = key expires in n years
Key is valid for? (0)
Key does not expire at all
Is this correct? (y/N) y
Really create? (y/N) y
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
.....+++++
...+++++

pub  4096R/0xAABBCCDDEEFFGGHH  created: 2015-10-27  expires: never       usage: SC
                               trust: ultimate      validity: ultimate
sub  2048R/0x1122334455667788  created: 2015-10-27  expires: never       usage: S
[ultimate] (1). Pippo Goofy &lt;pippo@example.com&gt;
[ultimate] (2)  Pippo Goofy &lt;pgoofy@keybase.io&gt;

gpg&gt; addkey
Key is protected.

You need a passphrase to unlock the secret key for
user: &quot;Pippo Goofy &lt;pippo@example.com&gt;&quot;
4096-bit RSA key, ID 0xAABBCCDDEEFFGGHH, created 2015-10-27

Please select what kind of key you want:
   (3) DSA (sign only)
   (4) RSA (sign only)
   (5) Elgamal (encrypt only)
   (6) RSA (encrypt only)
   (7) DSA (set your own capabilities)
   (8) RSA (set your own capabilities)
Your selection? 6
RSA keys may be between 1024 and 4096 bits long.
What keysize do you want? (2048)
Requested keysize is 2048 bits
Please specify how long the key should be valid.
         0 = key does not expire
      &lt;n&gt;  = key expires in n days
      &lt;n&gt;w = key expires in n weeks
      &lt;n&gt;m = key expires in n months
      &lt;n&gt;y = key expires in n years
Key is valid for? (0)
Key does not expire at all
Is this correct? (y/N) y
Really create? (y/N) y
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
..+++++
.........+++++

pub  4096R/0xAABBCCDDEEFFGGHH  created: 2015-10-27  expires: never       usage: SC
                               trust: ultimate      validity: ultimate
sub  2048R/0x1122334455667788  created: 2015-10-27  expires: never       usage: S
sub  2048R/0x1A2B3C4D5E6F7F8G  created: 2015-10-27  expires: never       usage: E
[ultimate] (1). Pippo Goofy &lt;pippo@example.com&gt;
[ultimate] (2)  Pippo Goofy &lt;pgoofy@keybase.io&gt;

gpg&gt; addkey
Key is protected.

You need a passphrase to unlock the secret key for
user: &quot;Pippo Goofy &lt;pippo@example.com&gt;&quot;
4096-bit RSA key, ID 0xAABBCCDDEEFFGGHH, created 2015-10-27

Please select what kind of key you want:
   (3) DSA (sign only)
   (4) RSA (sign only)
   (5) Elgamal (encrypt only)
   (6) RSA (encrypt only)
   (7) DSA (set your own capabilities)
   (8) RSA (set your own capabilities)
Your selection? 8

Possible actions for a RSA key: Sign Encrypt Authenticate
Current allowed actions: Sign Encrypt

   (S) Toggle the sign capability
   (E) Toggle the encrypt capability
   (A) Toggle the authenticate capability
   (Q) Finished

Your selection? s

Possible actions for a RSA key: Sign Encrypt Authenticate
Current allowed actions: Encrypt

   (S) Toggle the sign capability
   (E) Toggle the encrypt capability
   (A) Toggle the authenticate capability
   (Q) Finished

Your selection? e

Possible actions for a RSA key: Sign Encrypt Authenticate
Current allowed actions:

   (S) Toggle the sign capability
   (E) Toggle the encrypt capability
   (A) Toggle the authenticate capability
   (Q) Finished

Your selection? a

Possible actions for a RSA key: Sign Encrypt Authenticate
Current allowed actions: Authenticate

   (S) Toggle the sign capability
   (E) Toggle the encrypt capability
   (A) Toggle the authenticate capability
   (Q) Finished

Your selection? q
RSA keys may be between 1024 and 4096 bits long.
What keysize do you want? (2048)
Requested keysize is 2048 bits
Please specify how long the key should be valid.
         0 = key does not expire
      &lt;n&gt;  = key expires in n days
      &lt;n&gt;w = key expires in n weeks
      &lt;n&gt;m = key expires in n months
      &lt;n&gt;y = key expires in n years
Key is valid for? (0)
Key does not expire at all
Is this correct? (y/N) y
Really create? (y/N) y
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
....+++++
..+++++

pub  4096R/0xAABBCCDDEEFFGGHH  created: 2015-10-27  expires: never       usage: SC
                               trust: ultimate      validity: ultimate
sub  2048R/0x1122334455667788  created: 2015-10-27  expires: never       usage: S
sub  2048R/0x1A2B3C4D5E6F7F8G  created: 2015-10-27  expires: never       usage: E
sub  2048R/0xRXSNIDWKKWXVXGXN  created: 2015-10-27  expires: never       usage: A
[ultimate] (1). Pippo Goofy &lt;pippo@example.com&gt;
[ultimate] (2)  Pippo Goofy &lt;pgoofy@keybase.io&gt;

gpg&gt; save
</code></pre><p>Export your public key:</p><pre><code>$ gpg -a --export $KEY &gt; pubkey.asc
</code></pre><h3 id=configure-the-pin-on-the-yubikey>Configure the PIN on the YubiKey</h3><p>Personalize the YubiKey, for example to set the PIN:</p><pre><code>$ gpg2 --card-edit

Application ID ...: D30973728497183717309737284971837
Version ..........: 2.0
Manufacturer .....: Yubico
Serial number ....: 12345678
Name of cardholder: [not set]
Language prefs ...: [not set]
Sex ..............: unspecified
URL of public key : [not set]
Login data .......: [not set]
Signature PIN ....: forced
Key attributes ...: 2048R 2048R 2048R
Max. PIN lengths .: 127 127 127
PIN retry counter : 3 3 3
Signature counter : 0
Signature key ....: [none]
Encryption key....: [none]
Authentication key: [none]
General key info..: [none]

gpg/card&gt; admin
Admin commands are allowed

gpg/card&gt; passwd
gpg: OpenPGP card no. D2760001240102000006038112920000 detected

1 - change PIN
2 - unblock PIN
3 - change Admin PIN
4 - set the Reset Code
Q - quit

Your selection? 1
PIN changed.

1 - change PIN
2 - unblock PIN
3 - change Admin PIN
4 - set the Reset Code
Q - quit

Your selection? q

gpg/card&gt; url
URL to retrieve public key: https://keybase.io/pgoofy/key.asc

gpg/card&gt; name
Cardholder's surname: Goofy
Cardholder's given name: Pippo

gpg/card&gt; login
Login data (account name): pgoofy

gpg/card&gt; sex
Sex ((M)ale, (F)emale or space): m

gpg/card&gt; lang
Language preferences: en

gpg/card&gt; list

Application ID ...: D30973728497183717309737284971837
Version ..........: 2.0
Manufacturer .....: Yubico
Serial number ....: 12345678
Name of cardholder: Pippo Goofy
Language prefs ...: en
Sex ..............: male
URL of public key : https://keybase.io/pgoofy/key.asc
Login data .......: pgoofy
Signature PIN ....: forced
Key attributes ...: 2048R 2048R 2048R
Max. PIN lengths .: 127 127 127
PIN retry counter : 3 3 3
Signature counter : 0
Signature key ....: [none]
Encryption key....: [none]
Authentication key: [none]
General key info..: [none]

gpg/card&gt; quit
</code></pre><h3 id=upload-the-secret-keys-to-the-yubikey>Upload the secret keys to the YubiKey</h3><p><strong>IMPORTANT</strong> Backup your secret keys, because the next steps will delete them from the filesystem!</p><pre><code>$ tar -czf /media/BACKUP/gnupg.tgz ~/.gnupg
$ gpg2 -a --export-secret-key $KEY &gt;&gt; /media/BACKUP/${KEY}.master.key
$ gpg2 -a --export-secret-subkeys $KEY &gt;&gt; /media/BACKUP/${KEY}.sub.key
</code></pre><p>Now we upload the keys to the YubiKey while deleting them from the filesystem. Note: the <code>key</code>
command work like a <em>toggle</em>.</p><p>Note about the <code>keytocard</code> command:</p><blockquote><p>Transfer the selected secret subkey (or the primary key if no subkey has been selected) to a
smartcard. The secret key in the keyring will be replaced by a stub if the key could be stored
successfully on the card and you use the save command later. Only certain key types may be
transferred to the card. A sub menu allows you to select on what card to store the key. Note that
it is not possible to get that key back from the card - if the card gets broken your secret key
will be lost unless you have a backup somewhere.</p></blockquote><pre><code>$ gpg2 --edit-key $KEY
gpg (GnuPG) 2.0.28; Copyright (C) 2015 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Secret key is available.

pub  4096R/0xAABBCCDDEEFFGGHH  created: 2015-10-27  expires: never       usage: SC
                               trust: ultimate      validity: ultimate
sub  2048R/0x1122334455667788  created: 2015-10-27  expires: never       usage: S
sub  2048R/0x1A2B3C4D5E6F7F8G  created: 2015-10-27  expires: never       usage: E
sub  2048R/0xRXSNIDWKKWXVXGXN  created: 2015-10-27  expires: never       usage: A
[ultimate] (1). Pippo Goofy &lt;pippo@example.com&gt;
[ultimate] (2)  Pippo Goofy &lt;pgoofy@keybase.io&gt;

gpg&gt; toggle

sec  4096R/0xAABBCCDDEEFFGGHH  created: 2015-10-27  expires: never
ssb  2048R/0x1122334455667788  created: 2015-10-27  expires: never
ssb  2048R/0x1A2B3C4D5E6F7F8G  created: 2015-10-27  expires: never
ssb  2048R/0xRXSNIDWKKWXVXGXN  created: 2015-10-27  expires: never
(1)  Pippo Goofy &lt;pippo@example.com&gt;
(2)  Pippo Goofy &lt;pgoofy@keybase.io&gt;

gpg&gt; key 1

sec  4096R/0xAABBCCDDEEFFGGHH  created: 2015-10-27  expires: never
ssb* 2048R/0x1122334455667788  created: 2015-10-27  expires: never
ssb  2048R/0x1A2B3C4D5E6F7F8G  created: 2015-10-27  expires: never
ssb  2048R/0xRXSNIDWKKWXVXGXN  created: 2015-10-27  expires: never
(1)  Pippo Goofy &lt;pippo@example.com&gt;
(2)  Pippo Goofy &lt;pgoofy@keybase.io&gt;

gpg&gt; keytocard
Signature key ....: [none]
Encryption key....: [none]
Authentication key: [none]

Please select where to store the key:
   (1) Signature key
   (3) Authentication key
Your selection? 1

You need a passphrase to unlock the secret key for
user: &quot;Pippo Goofy &lt;pippo@example.com&gt;&quot;
2048-bit RSA key, ID 0x1122334455667788, created 2015-10-27


sec  4096R/0xAABBCCDDEEFFGGHH  created: 2015-10-27  expires: never
ssb* 2048R/0x1122334455667788  created: 2015-10-27  expires: never
                     card-no: 0001 12345678
ssb  2048R/0x1A2B3C4D5E6F7F8G  created: 2015-10-27  expires: never
ssb  2048R/0xRXSNIDWKKWXVXGXN  created: 2015-10-27  expires: never
(1)  Pippo Goofy &lt;pippo@example.com&gt;
(2)  Pippo Goofy &lt;pgoofy@keybase.io&gt;

gpg&gt; key 1

sec  4096R/0xAABBCCDDEEFFGGHH  created: 2015-10-27  expires: never
ssb  2048R/0x1122334455667788  created: 2015-10-27  expires: never
                     card-no: 0001 12345678
ssb  2048R/0x1A2B3C4D5E6F7F8G  created: 2015-10-27  expires: never
ssb  2048R/0xRXSNIDWKKWXVXGXN  created: 2015-10-27  expires: never
(1)  Pippo Goofy &lt;pippo@example.com&gt;
(2)  Pippo Goofy &lt;pgoofy@keybase.io&gt;

gpg&gt; key 2

sec  4096R/0xAABBCCDDEEFFGGHH  created: 2015-10-27  expires: never
ssb  2048R/0x1122334455667788  created: 2015-10-27  expires: never
                     card-no: 0001 12345678
ssb* 2048R/0x1A2B3C4D5E6F7F8G  created: 2015-10-27  expires: never
ssb  2048R/0xRXSNIDWKKWXVXGXN  created: 2015-10-27  expires: never
(1)  Pippo Goofy &lt;pippo@example.com&gt;
(2)  Pippo Goofy &lt;pgoofy@keybase.io&gt;

gpg&gt; keytocard
Signature key ....: 7AD1 CE4D E316 2B98 8EB2  98E1 9D29 E296 58EF 3A17
Encryption key....: [none]
Authentication key: [none]

Please select where to store the key:
   (2) Encryption key
Your selection? 2

You need a passphrase to unlock the secret key for
user: &quot;Pippo Goofy &lt;pippo@example.com&gt;&quot;
2048-bit RSA key, ID 0x1A2B3C4D5E6F7F8G, created 2015-10-27


sec  4096R/0xAABBCCDDEEFFGGHH  created: 2015-10-27  expires: never
ssb  2048R/0x1122334455667788  created: 2015-10-27  expires: never
                     card-no: 0001 12345678
ssb* 2048R/0x1A2B3C4D5E6F7F8G  created: 2015-10-27  expires: never
                     card-no: 0001 12345678
ssb  2048R/0xRXSNIDWKKWXVXGXN  created: 2015-10-27  expires: never
(1)  Pippo Goofy &lt;pippo@example.com&gt;
(2)  Pippo Goofy &lt;pgoofy@keybase.io&gt;

gpg&gt; key 2

sec  4096R/0xAABBCCDDEEFFGGHH  created: 2015-10-27  expires: never
ssb  2048R/0x1122334455667788  created: 2015-10-27  expires: never
                     card-no: 0001 12345678
ssb  2048R/0x1A2B3C4D5E6F7F8G  created: 2015-10-27  expires: never
                     card-no: 0001 12345678
ssb  2048R/0xRXSNIDWKKWXVXGXN  created: 2015-10-27  expires: never
(1)  Pippo Goofy &lt;pippo@example.com&gt;
(2)  Pippo Goofy &lt;pgoofy@keybase.io&gt;

gpg&gt; key 3

sec  4096R/0xAABBCCDDEEFFGGHH  created: 2015-10-27  expires: never
ssb  2048R/0x1122334455667788  created: 2015-10-27  expires: never
                     card-no: 0001 12345678
ssb  2048R/0x1A2B3C4D5E6F7F8G  created: 2015-10-27  expires: never
                     card-no: 0001 12345678
ssb* 2048R/0xRXSNIDWKKWXVXGXN  created: 2015-10-27  expires: never
(1)  Pippo Goofy &lt;pippo@example.com&gt;
(2)  Pippo Goofy &lt;pgoofy@keybase.io&gt;

gpg&gt; keytocard
Signature key ....: AAAA BBBB CCCC DDD EEEE  FFFF GGGG HHHH IIII LLL1
Encryption key....: AAAA BBBB CCCC DDD EEEE  FFFF GGGG HHHH IIII LLL2
Authentication key: [none]

Please select where to store the key:
   (3) Authentication key
Your selection? 3

You need a passphrase to unlock the secret key for
user: &quot;Pippo Goofy &lt;pippo@example.com&gt;&quot;
2048-bit RSA key, ID 0xRXSNIDWKKWXVXGXN, created 2015-10-27


sec  4096R/0xAABBCCDDEEFFGGHH  created: 2015-10-27  expires: never
ssb  2048R/0x1122334455667788  created: 2015-10-27  expires: never
                     card-no: 0001 12345678
ssb  2048R/0x1A2B3C4D5E6F7F8G  created: 2015-10-27  expires: never
                     card-no: 0001 12345678
ssb* 2048R/0xRXSNIDWKKWXVXGXN  created: 2015-10-27  expires: never
                     card-no: 0001 12345678
(1)  Pippo Goofy &lt;pippo@example.com&gt;
(2)  Pippo Goofy &lt;pgoofy@keybase.io&gt;

gpg&gt; save
</code></pre><p>If <code>gpg</code> seems stuck while trying to use the YubiKey, try to gently restart <code>gpg-agent</code>.</p><h3 id=final-check-and->Final check and ðŸ˜Œ</h3><p>Now you should see something like this:</p><pre><code>$ gpg2 --card-status
Application ID ...: D30973728497183717309737284971837
Version ..........: 2.0
Manufacturer .....: Yubico
Serial number ....: 12345678
Name of cardholder: Pippo Goofy
Language prefs ...: en
Sex ..............: male
URL of public key : https://keybase.io/pgoofy/key.asc
Login data .......: pgoofy
Signature PIN ....: forced
Key attributes ...: 2048R 2048R 2048R
Max. PIN lengths .: 127 127 127
PIN retry counter : 3 3 3
Signature counter : 0
Signature key ....: AAAA BBBB CCCC DDD EEEE  FFFF GGGG HHHH IIII LLL1
      created ....: 2015-10-27 20:06:12
Encryption key....: AAAA BBBB CCCC DDD EEEE  FFFF GGGG HHHH IIII LLL2
      created ....: 2015-10-27 20:07:01
Authentication key: AAAA BBBB CCCC DDD EEEE  FFFF GGGG HHHH IIII LLL3
      created ....: 2015-10-27 20:07:37
General key info..: pub  2048R/0x1122334455667788 2015-10-27 Pippo Goofy &lt;pippo@example.com&gt;
sec   4096R/0xAABBCCDDEEFFGGHH  created: 2015-10-27  expires: never
ssb&gt;  2048R/0x1122334455667788  created: 2015-10-27  expires: never
                      card-no: 0001 12345678
ssb&gt;  2048R/0x1A2B3C4D5E6F7F8G  created: 2015-10-27  expires: never
                      card-no: 0001 12345678
ssb&gt;  2048R/0xRXSNIDWKKWXVXGXN  created: 2015-10-27  expires: never
                      card-no: 0001 12345678
</code></pre><p>To export your public SSH key, run:</p><pre><code>$ SSH_AUTH_SOCK=$HOME/.gnupg/S.gpg-agent.ssh ssh-add -L
</code></pre><p>and copy the output to <code>~/.ssh/yubikey.pub</code> or something similar.</p><p>With a sufficient recent version of OpenSSH you can also use this key only for some hosts, with
something like:</p><pre><code>Host example.com
  IdentityFile ~/.ssh/yubikey.pub
  IdentityAgent ~/.gnupg/S.gpg-agent.ssh
</code></pre></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2018-03-26</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://blog.spatof.org/posts/2018/03/yubikey-and-gpg/ data-title="YubiKey and GPG"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://blog.spatof.org/posts/2018/03/yubikey-and-gpg/><i class="fab fa-reddit fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/yubikey/>Yubikey</a>,&nbsp;<a href=/tags/gpg/>Gpg</a>,&nbsp;<a href=/tags/gpg2/>Gpg2</a>,&nbsp;<a href=/tags/ssh/>Ssh</a>,&nbsp;<a href=/tags/gpg-agent/>Gpg-Agent</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/2018/02/into-the-breach-on-os-x-with-wine/ class=prev rel=prev title="Into the Breach on OS X with Wine"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Into the Breach on OS X with Wine</a>
<a href=/posts/2018/12/ferm-and-docker-playing-together/ class=next rel=next title="ferm and docker playing together">ferm and docker playing together<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><script type=text/javascript src=https://storage.ko-fi.com/cdn/widget/Widget_2.js></script><script type=text/javascript>kofiwidget2.init("Support Me on Ko-fi","#29abe0","U6U07489O"),kofiwidget2.draw()</script></div><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.143.1">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2013 - 2025</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Daniel Kertesz</a></span>&nbsp;|&nbsp;<span class=license><a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/><img alt="Creative Commons License" style=border-width:0 src=https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png></a><br>This work is licensed under a <a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.</span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:500},comment:{},search:{highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:30}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>