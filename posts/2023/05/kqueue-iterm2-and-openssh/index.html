<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Kqueue, iTerm2 and OpenSSH - Daniel's blog</title><meta name=Description content="This is my cool site"><meta property="og:title" content="Kqueue, iTerm2 and OpenSSH"><meta property="og:description" content="Explore a couple of solutions to write the hostname of an ssh connection in an iTerm2 badge."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.spatof.org/posts/2023/05/kqueue-iterm2-and-openssh/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-05-06T20:00:00+01:00"><meta property="article:modified_time" content="2023-05-06T20:00:00+01:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary"><meta name=twitter:title content="Kqueue, iTerm2 and OpenSSH"><meta name=twitter:description content="Explore a couple of solutions to write the hostname of an ssh connection in an iTerm2 badge."><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.spatof.org/posts/2023/05/kqueue-iterm2-and-openssh/><link rel=prev href=https://blog.spatof.org/posts/2022/04/nginx-x-forwarded-for-and-the-realip-module/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Kqueue, iTerm2 and OpenSSH","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.spatof.org\/posts\/2023\/05\/kqueue-iterm2-and-openssh\/"},"genre":"posts","keywords":"macOS, ssh, Go","wordcount":3051,"url":"https:\/\/blog.spatof.org\/posts\/2023\/05\/kqueue-iterm2-and-openssh\/","datePublished":"2023-05-06T20:00:00+01:00","dateModified":"2023-05-06T20:00:00+01:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Daniel Kertesz"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Daniel's blog">blog.spatof.org</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/ title=About>About </a><a class=menu-item href=/youtube-links/ title="Youtube Links">Youtube Links </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Daniel's blog">blog.spatof.org</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title=About>About</a><a class=menu-item href=/youtube-links/ title="Youtube Links">Youtube Links</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Kqueue, iTerm2 and OpenSSH</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Daniel Kertesz</a></span>&nbsp;<span class=post-category>included in <a href=/categories/tips-and-tricks/><i class="far fa-folder fa-fw" aria-hidden=true></i>Tips and Tricks</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-05-06>2023-05-06</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;3051 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;15 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#a-word-of-warning>A word of warning</a></li><li><a href=#implementation>Implementation</a><ul><li><a href=#doing-it-with-a-zsh-shell-script>Doing it with a (zsh) shell script</a></li><li><a href=#doing-it-with-kqueue>Doing it with kqueue</a></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=introduction>Introduction</h2><p>One of iTerm2&rsquo;s under appreciated features is the ability to display <a href=https://iterm2.com/documentation-badges.html target=_blank rel="noopener noreffer">badges</a> in the terminal window;
these badges are basically an overlay text that is rendered behind the actual terminal text, and can be really useful to give <em>context</em> to a terminal
window.</p><p>In this post I&rsquo;ll describe how to integrate this feature with OpenSSH to display the remote hostname during an <code>ssh</code> session; the picture below shows
how it looks like on my computer:</p><figure><a class=lightgallery href=/images/iterm2-badge.png title=/images/iterm2-badge.png data-thumbnail=/images/iterm2-badge.png data-sub-html="<h2>A screenshot of iTerm2 with a badge</h2>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/iterm2-badge.png data-srcset="/images/iterm2-badge.png, /images/iterm2-badge.png 1.5x, /images/iterm2-badge.png 2x" data-sizes=auto alt=/images/iterm2-badge.png></a><figcaption class=image-caption>A screenshot of iTerm2 with a badge</figcaption></figure><h2 id=a-word-of-warning>A word of warning</h2><p>Adding something that you don&rsquo;t fully understand to your everyday configuration might lead to unpleasant surprises, which is something that tend to
happen at the worst possible time. One of the <em>tricks</em> that I&rsquo;ll mention later in this post, for example, had a subtle bug that went unnoticed for
years, until one day it manifested itself while I was working (of course!).</p><p>On the other hand having the hostname of the remote machine clearly displayed in my terminal&rsquo;s window is exactly the kind of things that I find very
useful at work, and I think it was worth the effort of researching, testing and implementing.</p><h2 id=implementation>Implementation</h2><p>To display a badge in iTerm2 you need to <em>echo</em> a special escape sequence; with a shell like bash or zsh, for example, you can try this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>printf</span> <span class=s2>&#34;\e]1337;SetBadgeFormat=%s\a&#34;</span> <span class=s2>&#34;</span><span class=k>$(</span><span class=nb>echo</span> mymachine.net <span class=p>|</span> base64<span class=k>)</span><span class=s2>&#34;</span>
</span></span></code></pre></div><p>and to clear the badge you can simply print the same escape sequence without any text:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>printf</span> <span class=s2>&#34;\e]1337;SetBadgeFormat=\a&#34;</span>
</span></span></code></pre></div><p>Knowing this, the two remaining piece of the puzzle are:</p><ul><li>detecting the hostname of the machine we&rsquo;re connecting to with ssh</li><li>print the escape sequence when ssh connects to the remote machine</li></ul><p>Also, since we like nice things that works properly, it would be nice to find a way to clear the badge when the remote connection is closed.</p><h3 id=doing-it-with-a-zsh-shell-script>Doing it with a (zsh) shell script</h3><p>The first option I&rsquo;ll describe uses a shell script, since after all this seems exactly the kind of problem shells are meant to solve. I&rsquo;ve already
written about this in the past (in <a href=https://blog.spatof.org/posts/2013/03/use-the-name-of-the-remote-host-for-tmux-window-when-running-ssh/ rel>two</a> <a href=https://blog.spatof.org/posts/2019/12/rename-the-tmux-or-iterm2-window-when-connecting-to-a-remote-host/ rel>different</a>
posts), so here I&rsquo;ll just describe the strategy.</p><p>First we need to intercept the execution of the <code>ssh</code> command, and to do so we can define a <em>shell function</em> with the same name that then calls the
actual command. With the proper separation of <em>general</em> shell configuration and <em>interactive</em> shell configuration, we can ensure that this function
will only be used in <strong>interactive</strong> shells and not in <strong>shell scripts</strong>; in Zsh this means that we won&rsquo;t load this shell function in <code>zshenv</code> and
instead we will load it in <code>zshrc</code>.</p><p>The actual complicate part of this approach is finding a way to extract the remote hostname from the command-line, taking into account that we could
be simply typing <code>ssh example.com</code> or we would be passing options to <code>ssh</code> itself; the initial version of my script used Perl&rsquo;s regular expressions to
do that:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>local</span> <span class=nv>hostname</span><span class=o>=</span><span class=k>$(</span>perl -e <span class=s1>&#39;if ($#ARGV == 0) { print $ARGV[0]; } else {foreach $h (@ARGV) { if ($h =~ /^(?&lt;!-)(?:\w+@)?([^.]+\.[^.]+\..*)/) { print $+; exit; } } }&#39;</span> -- <span class=nv>$@</span><span class=k>)</span>
</span></span></code></pre></div><p>Here we&rsquo;re assigning to <code>hostname</code> the output of a Perl script, to which we&rsquo;re passing <code>$@</code> as the input; <code>$@</code> is a shell positional parameter
containing all command-line arguments.</p><p>Breaking down this Perl oneliner we have:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nv>$#ARGV</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>print</span> <span class=nv>$ARGV</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>foreach</span> <span class=nv>$h</span> <span class=p>(</span><span class=nv>@ARGV</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nv>$h</span> <span class=o>=~</span><span class=sr> /^(?&lt;!-)(?:\w+@)?([^.]+\.[^.]+\..*)/</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>print</span> <span class=vg>$+</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nb>exit</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This script iterates over <code>@ARGV</code> (again, the command-line arguments) when its length is major than 0; for each string in <code>@ARGV</code> we check with a
regular expression if it match what an hostname usually looks like.</p><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon fas fa-lightbulb fa-fw" aria-hidden=true></i>Tip<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>To learn more about Perl&rsquo;s regular expression check the <code>perlre</code> man page.</div></div></div><p>Let&rsquo;s ask ChatGPT to explain this regular expression:</p><ul><li><code>/^</code> matches the start of the string.</li><li><code>(?&lt;!-)</code> is a negative lookbehind assertion that matches the position where the previous character is not a dash (<code>-</code>).</li><li><code>(?:\w+@)?</code> is a non-capturing group that matches an optional word (alphanumeric characters and underscore) followed by an at symbol <code>@</code>. The <code>?</code> at the end of the group makes it optional.</li><li><code>([^.]+\.[^.]+\..*)</code> is a capturing group that matches a domain name. It matches the following:<ul><li><code>[^.]+</code> matches one or more characters that are not a period <code>.</code>.</li><li><code>\.</code> matches a period <code>.</code>.</li><li><code>[^.]+</code> matches one or more characters that are not a period <code>.</code>.</li><li><code>\.</code> matches a period <code>.</code>.</li><li><code>.*</code> matches any remaining characters in the string.</li></ul></li></ul><blockquote><p>So, the regular expression matches a string that starts with a domain name, optionally preceded by a word and an at symbol, and the domain name must
not begin with a dash &ldquo;-&rdquo;. For example, it would match &ldquo;example.com&rdquo; and &ldquo;subdomain.example.co.uk&rdquo;, but not &ldquo;-example.com&rdquo; or &ldquo;example.&rdquo;.</p></blockquote><p>Unfortunately we can already see a flaw in this approach: the regexp won&rsquo;t match a single word hostname, like <code>localhost</code>; it&rsquo;s not uncommon to
configure OpenSSH to alias an hostname to a friendly single word name, like <code>db</code> for <code>db.example.com</code>. Nevertheless this approach was good enough and
I used it for a while.</p><p>For the next version of this script I copied an approach that I saw in someone else&rsquo;s dotfiles, which I found quite clever: use <code>getops</code> to simulate
the command-line arguments of OpenSSH. This way we can be sure that by the time we finish parsing all the <em>option</em> arguments, the next one will be the
actual remote hostname:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=k>while</span> <span class=nb>getopts</span> <span class=s2>&#34;:1246AaCfGgKkMNnqsTtVvXxYyb:c:D:E:e:F:I:i:L:l:m:O:o:p:Q:R:S:W:w:&#34;</span> option<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>local</span> <span class=nv>hostname</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>eval</span> <span class=nv>hostname</span><span class=o>=</span><span class=s2>&#34;\${</span><span class=nv>$OPTIND</span><span class=s2>}&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>OPTIND</span><span class=o>=</span><span class=m>1</span>
</span></span></code></pre></div><p>The last iteration of this script offloads the whole problem to OpenSSH by leveraging the <code>-G</code> option:</p><blockquote><p><code>-G</code> Causes ssh to print its configuration after evaluating Host and Match blocks and exit.</p></blockquote><p>If we prepend <code>-G</code> to the command-line arguments for <code>ssh</code>, the output will look like this:</p><pre tabindex=0><code>user myuser
hostname meriadoc.lan
port 22
addressfamily any
batchmode no
[...]
</code></pre><p>And so we can easily get what <code>ssh</code> considers to be the remote hostname using <code>awk</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ssh -G <span class=s2>&#34;</span><span class=nv>$@</span><span class=s2>&#34;</span> <span class=p>|</span> awk <span class=s1>&#39;NR &gt; 2 { exit } /^hostname/ { print $2 }&#39;</span>
</span></span></code></pre></div><p>The output of <code>ssh -G</code> follows a fixed order, so we know that we can exit <code>awk</code> after the 2nd line (<code>NR > 2 { exit }</code>); we match any line starting
with <code>hostname</code> and we print the second token of that line, the remote hostname.</p><p>Technically we&rsquo;re done with the problem of detecting the remote hostname, but I had another requirement: the infrastructure that I managed at that
time had machines with long hostnames that described some of their metadata, and I didn&rsquo;t want to display all of that.</p><p>A typical hostname had the following components:</p><ul><li>the machine&rsquo;s &ldquo;cattle&rdquo; name (e.g. <code>proxy1</code>)</li><li>a partition ID (e.g. <code>group1</code>)</li><li>an geographical region, similar to what AWS uses (e.g. <code>use1</code> for <code>us-east-1</code>)</li><li>a domain indicating whether the machine was in a testing or a production environment</li><li>the top-level domain</li></ul><p>Rather than having <code>proxy1.group1.use1.testing-example.com</code>, I wanted to have a shorter version: <code>proxy1.group1.use1</code>; do achieve that I wrote a
simple algorithm in Zsh:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>local</span> <span class=nv>parts</span><span class=o>=(</span><span class=si>${</span><span class=p>(s:.:)hostname</span><span class=si>}</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nb>local</span> short_name
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># if it&#39;s an IP don&#39;t shorten it and use it as it is</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nb>echo</span> <span class=nv>$hostname</span> <span class=p>|</span> grep -qE <span class=s2>&#34;^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}</span>$<span class=s2>&#34;</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nv>short_name</span><span class=o>=</span><span class=nv>$hostname</span>
</span></span><span class=line><span class=cl><span class=c1># if the parts of the hostname are less than 3 (e.g. mail.example.com -&gt; 3 parts) use the first part</span>
</span></span><span class=line><span class=cl><span class=c1># only (e.g. &#34;mail&#34;).</span>
</span></span><span class=line><span class=cl><span class=k>elif</span> <span class=o>((</span> <span class=nv>$#</span>parts &lt;<span class=o>=</span> <span class=m>3</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nv>short_name</span><span class=o>=</span><span class=si>${</span><span class=nv>parts</span><span class=p>[1]</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=c1># othewrise show 2/3 of the hostname</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>fraction</span><span class=o>=</span><span class=k>$((</span> <span class=nv>$#</span>parts <span class=o>/</span> <span class=m>3</span> <span class=o>*</span> <span class=m>2</span> <span class=k>))</span>
</span></span><span class=line><span class=cl>    <span class=nv>short_name</span><span class=o>=</span><span class=si>${</span><span class=p>(j:.:)parts[1,</span><span class=nv>$fraction</span><span class=p>]</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span></code></pre></div><p>Now we can <em>finally</em> print the escape sequence for iTerm2 and display the short remote hostname in a badge. You can find this version of this script
in my dotfiles repository on GitHub: <a href=https://github.com/piger/Preferences/blob/e0002cec9eb0ff0a9b1fefc92c7bba16ae031ef3/zsh/functions/ssh target=_blank rel="noopener noreffer">ssh function</a>.</p><p>So far this worked quite well for me, except for a small bug that I failed to notice for a long time: executing <code>ssh</code> without any option or parameter
would cause the whole shell session to terminate. This happens when the script fails to detect the remote hostname and executes <code>exec command ssh $@</code>;
<code>exec</code> replaces the current process with another one, and since that process terminates immediately, so does your terminal window.</p><p>One fix is to avoid using <code>exec</code> and instead calling <code>return</code> after invoking <code>ssh</code>, to exit the script.</p><h3 id=doing-it-with-kqueue>Doing it with kqueue</h3><p>If you read the man page <code>ssh_config</code> you will notice that OpenSSH has a <code>LocalCommand</code> option:</p><blockquote><p>Specifies a command to execute on the local machine after successfully connecting to the server. The command string extends to the end of the line,
and is executed with the user&rsquo;s shell. Arguments to LocalCommand accept the tokens described in the TOKENS section.</p><p>The command is run synchronously and does not have access to the session of the ssh(1) that spawned it. It should not be used for interactive
commands.</p></blockquote><p>Among the available <em>TOKENS</em> we have <code>%h</code> which contains the remote hostname. It would seem that by using <code>LocalCommand</code> we could really simplify the
solution to our problem&mldr; except for one small detail: the command is run <strong>synchronously</strong>, so we can set the badge after the connections is
established, but we can&rsquo;t unset it when the connection ends, as our <code>LocalCommand</code> must terminate to let <code>ssh</code> continue its execution.</p><p>As an aside, knowing how OpenSSH executes the command in <code>LocalCommand</code> might help our investigation, so let&rsquo;s <a href=https://github.com/openssh/openssh-portable/blob/0e9e2663eb2c6e9c3e10d15d70418312ae67e542/sshconnect.c#L1654 target=_blank rel="noopener noreffer">take a look</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nf>ssh_local_cmd</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>shell</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>pid_t</span> <span class=n>pid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>status</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>osighand</span><span class=p>)(</span><span class=kt>int</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>options</span><span class=p>.</span><span class=n>permit_local_command</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>	    <span class=n>args</span> <span class=o>==</span> <span class=nb>NULL</span> <span class=o>||</span> <span class=o>!*</span><span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>((</span><span class=n>shell</span> <span class=o>=</span> <span class=nf>getenv</span><span class=p>(</span><span class=s>&#34;SHELL&#34;</span><span class=p>))</span> <span class=o>==</span> <span class=nb>NULL</span> <span class=o>||</span> <span class=o>*</span><span class=n>shell</span> <span class=o>==</span> <span class=sc>&#39;\0&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>shell</span> <span class=o>=</span> <span class=n>_PATH_BSHELL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>osighand</span> <span class=o>=</span> <span class=nf>ssh_signal</span><span class=p>(</span><span class=n>SIGCHLD</span><span class=p>,</span> <span class=n>SIG_DFL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>pid</span> <span class=o>=</span> <span class=nf>fork</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>pid</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>ssh_signal</span><span class=p>(</span><span class=n>SIGPIPE</span><span class=p>,</span> <span class=n>SIG_DFL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>debug3</span><span class=p>(</span><span class=s>&#34;Executing %s -c </span><span class=se>\&#34;</span><span class=s>%s</span><span class=se>\&#34;</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>shell</span><span class=p>,</span> <span class=n>args</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>execl</span><span class=p>(</span><span class=n>shell</span><span class=p>,</span> <span class=n>shell</span><span class=p>,</span> <span class=s>&#34;-c&#34;</span><span class=p>,</span> <span class=n>args</span><span class=p>,</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>error</span><span class=p>(</span><span class=s>&#34;Couldn&#39;t execute %s -c </span><span class=se>\&#34;</span><span class=s>%s</span><span class=se>\&#34;</span><span class=s>: %s&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		    <span class=n>shell</span><span class=p>,</span> <span class=n>args</span><span class=p>,</span> <span class=nf>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span>
</span></span><span class=line><span class=cl>		<span class=nf>_exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>pid</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nf>fatal</span><span class=p>(</span><span class=s>&#34;fork failed: %.100s&#34;</span><span class=p>,</span> <span class=nf>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=k>while</span> <span class=p>(</span><span class=nf>waitpid</span><span class=p>(</span><span class=n>pid</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>status</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>errno</span> <span class=o>!=</span> <span class=n>EINTR</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nf>fatal</span><span class=p>(</span><span class=s>&#34;Couldn&#39;t wait for child: %s&#34;</span><span class=p>,</span> <span class=nf>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=nf>ssh_signal</span><span class=p>(</span><span class=n>SIGCHLD</span><span class=p>,</span> <span class=n>osighand</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>WIFEXITED</span><span class=p>(</span><span class=n>status</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=p>(</span><span class=nf>WEXITSTATUS</span><span class=p>(</span><span class=n>status</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Essentially what happens here is the typical fork+exec, with the <em>local command</em> being executed by the user&rsquo;s shell with the <code>-c</code> flag.</p><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>The first part of this post wasn&rsquo;t really macOS specific, since many terminals and terminal multiplexers allow to alter the title of a window or a
panel by echoing escape sequences; the following part though only applies to BSDs and derivates, like Darwin. There might be a way to achieve the same
thing in Linux, but that will be left as an exercise for the reader :)</div></div></div><p>In a StackOverflow <a href=https://serverfault.com/a/641004 target=_blank rel="noopener noreffer">answer</a> by the user <a href=https://serverfault.com/users/14858/wfaulk target=_blank rel="noopener noreffer">wfaulk</a> I learned about a nice
trick: you can use <code>kqueue</code> to have a program wait for another program to terminate and receive an <em>event</em> when that happens; specifically, we want
to set up a kqueue filter for <code>EVFILT_PROC</code>:</p><blockquote><p>Takes the process ID to monitor as the identifier and the events to watch for in fflags, and returns when the process performs one or more of the
requested events. If a process can normally see another process, it can attach an event to it.</p></blockquote><p>and we want to watch for the event <code>NOTE_EXIT</code>, which is emitted when the monitored process exits.</p><p>The StackOverflow <a href=https://serverfault.com/a/641004 target=_blank rel="noopener noreffer">answer</a> shows how to do it in C, so if that&rsquo;s ok for you, the only other missing piece is to find
a way to encode the string that will be sent to iTerm2 in base64; for that you could use something like <a href=https://github.com/jwerle/b64.c target=_blank rel="noopener noreffer">b64.c</a>.</p><p>In Go we need to venture into the <a href=https://pkg.go.dev/syscall target=_blank rel="noopener noreffer">syscall</a> package, from which we need:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Kqueue</span><span class=p>()</span> <span class=p>(</span><span class=nx>fd</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Kevent</span><span class=p>(</span><span class=nx>kq</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>changes</span><span class=p>,</span> <span class=nx>events</span> <span class=p>[]</span><span class=nx>Kevent_t</span><span class=p>,</span> <span class=nx>timeout</span> <span class=o>*</span><span class=nx>Timespec</span><span class=p>)</span> <span class=p>(</span><span class=nx>n</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Kevent_t</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Ident</span>  <span class=kt>uint64</span>
</span></span><span class=line><span class=cl>	<span class=nx>Filter</span> <span class=kt>int16</span>
</span></span><span class=line><span class=cl>	<span class=nx>Flags</span>  <span class=kt>uint16</span>
</span></span><span class=line><span class=cl>	<span class=nx>Fflags</span> <span class=kt>uint32</span>
</span></span><span class=line><span class=cl>	<span class=nx>Data</span>   <span class=kt>int64</span>
</span></span><span class=line><span class=cl>	<span class=nx>Udata</span>  <span class=o>*</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon fas fa-lightbulb fa-fw" aria-hidden=true></i>Tip<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>The easiest way to read the Go documentation for these functions and structs is to run <code>go doc</code> on a macOS machine;
you&rsquo;ll also need to keep the man page for <code>kqueue</code> handy.</div></div></div><p>First we need a <em>kqueue file descriptor</em>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=nx>kq</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>syscall</span><span class=p>.</span><span class=nf>Kqueue</span><span class=p>()</span>
</span></span></code></pre></div><p>Then we need to create a <code>syscall.Kevent_t</code> describing the kind of event we want to monitor:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>ppid</span> <span class=kt>uint64</span> <span class=p>=</span> <span class=mi>12345</span> <span class=c1>// in the real program this will be our parent&#39;s pid.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>event</span> <span class=o>:=</span> <span class=nx>syscall</span><span class=p>.</span><span class=nx>Kevent_t</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Ident</span><span class=p>:</span>  <span class=nx>ppid</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Filter</span><span class=p>:</span> <span class=nx>syscall</span><span class=p>.</span><span class=nx>EVFILT_PROC</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Flags</span><span class=p>:</span>  <span class=nx>syscall</span><span class=p>.</span><span class=nx>EV_ADD</span> <span class=p>|</span> <span class=nx>syscall</span><span class=p>.</span><span class=nx>EV_ONESHOT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Fflags</span><span class=p>:</span> <span class=nx>syscall</span><span class=p>.</span><span class=nx>NOTE_EXIT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Data</span><span class=p>:</span>   <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Udata</span><span class=p>:</span>  <span class=kc>nil</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>With this struct we&rsquo;re telling the kernel that we want to add a new process filter, have it only trigger once (<code>EV_ONESHOT</code>) and only monitor for the
<code>NOTE_EXIT</code> event. Once we have this we need to set up a container for the event that we will receive from kqueue and then finally instantiate the
filter:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=nx>events</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=nx>syscall</span><span class=p>.</span><span class=nx>Kevent_t</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>nev</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>syscall</span><span class=p>.</span><span class=nf>Kevent</span><span class=p>(</span><span class=nx>kq</span><span class=p>,</span> <span class=p>[]</span><span class=nx>syscall</span><span class=p>.</span><span class=nx>Kevent_t</span><span class=p>{</span><span class=nx>event</span><span class=p>},</span> <span class=nx>events</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed kevent(): %w&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>nev</span> <span class=p>&lt;</span> <span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;no events returned&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Note that we&rsquo;re using <code>nil</code> for the last parameter, which expects a pointer to a <code>syscall.Timespec</code>; this is necessary if we want our kqueue filter to
expire after a set amount of time. In this case I&rsquo;m fine with having no timeout at all, so we can pass <code>nil</code>.</p><p>The first return value of <code>syscall.Kevent</code>, <code>nev</code>, contains the number of events read, so we have to check if it reports at least one.</p><p>So now we have a way to detect when a process exits, and if we expect our program to be executed as sub-process of ssh, we can then use <code>os.Getppid()</code>
to get our parent&rsquo;s pid.</p><p>The escape sequence for iTerm2 is easy to implement, we only need to convert <code>\e</code> from the escape sequence in something that a non-shell can
understand; in this case <code>\e</code> corresponds to the escape sequence for the <em>escape</em> character, which we can represent with <code>\033</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>setItermBadge</span><span class=p>(</span><span class=nx>msg</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;\033]1337;SetBadgeFormat=%s\a&#34;</span><span class=p>,</span> <span class=nx>base64</span><span class=p>.</span><span class=nx>StdEncoding</span><span class=p>.</span><span class=nf>EncodeToString</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>msg</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>clearItermBadge</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;\033]1337;SetBadgeFormat=\a&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The last piece of our puzzle is also the most complicate: ssh executes <code>LocalCommand</code> synchronously, but we really want our program to be asynchronous
and in Go we just can&rsquo;t use <code>fork()</code>. Well, technically we can, but doing so will break the Go runtime; what happens in practice is that if we run
something like <code>syscall.Syscall(syscall.SYS_FORK, 0, 0, 0)</code> and then in the child process we try to set up a Kqueue filter, we&rsquo;ll get an &ldquo;interrupted
syscall&rdquo; error message. So yeah, we can&rsquo;t really fork in the same way the <a href=https://serverfault.com/a/641004 target=_blank rel="noopener noreffer">C program</a> in StackOverflow is doing.</p><p>Now wait&mldr; when we looked at the OpenSSH code that executes the local command, we saw that is using the equivalent of <code>bash -c</code>, so could we just
specify a <code>LocalCommand</code> that terminates with <code>&</code> and let the shell take care of running our command in background? Let&rsquo;s see.</p><p>We&rsquo;ll write a simple Go program that prints its parent PID, and run it as a <code>LocalCommand</code> in ssh, first in the regular way and then with <code>&</code> and see
what happens.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;ppid: %d\n&#34;</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Getppid</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>In <code>$HOME/.ssh/config</code> we put this configuration, making sure that other <code>Host</code> lines won&rsquo;t interfere with our experiment:</p><pre tabindex=0><code>Host *
  PermitLocalCommand yes
  LocalCommand /path/to/goppid/goppid
</code></pre><p>When we ssh to a remote machine we&rsquo;ll get something like this:</p><pre tabindex=0><code>$ ssh meriadoc
ppid: 53169
Linux meriadoc 6.1.21-v8+ #1642 SMP PREEMPT Mon Apr  3 17:24:16 BST 2023 aarch64
</code></pre><p>Where 53169 is the PID of that <code>ssh</code> command. Now let&rsquo;s see what happens if we run the same <code>LocalCommand</code> with an <code>&</code> at the end: <code>LocalCommand /path/to/goppid/goppid &</code>:</p><pre tabindex=0><code>$ ssh meriadoc
ppid: 1
       Linux meriadoc 6.1.21-v8+ #1642 SMP PREEMPT Mon Apr  3 17:24:16 BST 2023 aarch64
</code></pre><p>The first difference is that the output from ssh is <em>confused</em> and now the length of our Go program&rsquo;s output is prepended as whitespace to the actual
output from ssh; most importantly, the reported parent PID is now 1. In Linux pid 1 is <code>init</code> while in macOS is <code>launchd</code> and either way that&rsquo;s
definitely not the <code>ssh</code> command.</p><p>This generally happens when a parent process exits without properly waiting for its child processes to exit as well;
in this case the kernel will assign pid 1 as the parent process of the orphaned process.</p><p>So we can&rsquo;t use <code>fork()</code> like in C and we can&rsquo;t create a background process with the shell. What other options do we have? We know that <code>fork()</code> will
interfere with Go&rsquo;s runtime and the child process will misbehave, but nothing prevents us from using <code>fork</code> <em>and</em> <code>exec</code> to spawn another process from
our Go program, which means that we can write a program that:</p><ul><li>gets its parent&rsquo;s pid (the <code>ssh</code> command)</li><li>re-executes itself passing this pid as a command-line parameter</li><li>exit without waiting for its <em>clone</em> to terminate, to avoid blocking the execution of <code>ssh</code></li></ul><p>The last important detail is about <code>exec.Command</code>&rsquo;s behavior in Go: an <code>exec.Cmd</code> struct will connect its Stdout and Stderr to <code>/dev/null</code>, unless we
attach them to something. We need iTerm2 to <em>see</em> our escape sequence, so the parent Go process must pass its Stdout to its child.</p><p>There&rsquo;s just one thing which I&rsquo;m not sure about: should the child process be placed in its own process group? From my testing so far it doesn&rsquo;t really
seems to make any difference.</p><p>I actually lied earlier as there&rsquo;s yet another important bit to consider, which also should make you realize why all of this is a fun learning
exercise but not a good idea: what happens when <code>ssh</code> is not executed by a human, but is instead executed by another program, like for example the
Emacs package <a href=https://magit.vc/ target=_blank rel="noopener noreffer">magit</a> or <a href=https://www.ansible.com/ target=_blank rel="noopener noreffer">Ansible</a>? Bad things, because the escape sequence for iTerm2 will be mixed in
ssh own output! Can we avoid this issue by linking the parent&rsquo;s Stderr to the child&rsquo;s Stdout? iTerm2 doesn&rsquo;t seems to mind, but a better solution is
not print anything at all when the destination stream is not a Terminal.</p><p>In Go we can check if a stream is a Terminal using <a href=https://pkg.go.dev/golang.org/x/term#IsTerminal target=_blank rel="noopener noreffer">term.IsTerminal</a>, so our main process can just
check if its <code>os.Stdout</code> is a Terminal and exit early when it&rsquo;s not.</p><p>You can find the source code of this program on my GitHub: <a href=https://github.com/piger/ssh-iterm2-badge target=_blank rel="noopener noreffer">https://github.com/piger/ssh-iterm2-badge</a>; to
use it you need to configure OpenSSH accordingly:</p><pre tabindex=0><code>Host *
  PermitLocalCommand yes
  LocalCommand ssh-iterm2-badge %h
</code></pre><p>You just need to ensure that no other <code>Host</code> directive is setting another <code>LocalCommand</code> or disabling <code>PermitLocalCommand</code> before this configuration
block is reached.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-05-06</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://blog.spatof.org/posts/2023/05/kqueue-iterm2-and-openssh/ data-title="Kqueue, iTerm2 and OpenSSH"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://blog.spatof.org/posts/2023/05/kqueue-iterm2-and-openssh/><i class="fab fa-reddit fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/macos/>macOS</a>,&nbsp;<a href=/tags/ssh/>ssh</a>,&nbsp;<a href=/tags/go/>Go</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/2022/04/nginx-x-forwarded-for-and-the-realip-module/ class=prev rel=prev title="NGINX, X-Forwarded-For and the realip module"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>NGINX, X-Forwarded-For and the realip module</a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><script type=text/javascript src=https://storage.ko-fi.com/cdn/widget/Widget_2.js></script><script type=text/javascript>kofiwidget2.init("Support Me on Ko-fi","#29abe0","U6U07489O"),kofiwidget2.draw()</script></div><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.111.3">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2013 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Daniel Kertesz</a></span>&nbsp;|&nbsp;<span class=license><a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/><img alt="Creative Commons License" style=border-width:0 src=https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png></a><br>This work is licensed under a <a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.</span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:500},comment:{},search:{highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:30}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>